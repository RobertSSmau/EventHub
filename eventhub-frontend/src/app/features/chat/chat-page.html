<div class="chat-layout">
  <aside class="sidebar">
    <header>
      <button type="button" class="back-btn" (click)="goBack()">← Back</button>
      <h2>Conversations</h2>
      <input
        type="text"
        placeholder="Search..."
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange()"
      >
    </header>

    @if (conversationsLoading) {
      <div class="state">Loading...</div>
    } @else if (conversationsError) {
      <div class="error-message">{{ conversationsError }}</div>
    } @else if (!filteredConversations.length) {
      <div class="state">No conversations yet.</div>
    } @else {
      <ul class="conversation-list">
        @for (conversation of filteredConversations; track conversation._id) {
          <li
            [class.active]="selectedConversation?._id === conversation._id"
            (click)="selectConversation(conversation)"
          >
            <div class="title-row">
              <h3>{{ conversation.displayName || 'Conversation' }}</h3>
              <small>{{ conversation.lastMessage?.timestamp | date:'shortTime' }}</small>
            </div>
            <p>{{ conversation.lastMessage?.content || 'No messages yet' }}</p>
            <div class="meta">
              @if (conversation.unreadCount) {
                <span class="pill">{{ conversation.unreadCount }}</span>
              }
              <span class="type">{{ conversation.type }}</span>
            </div>
            @if (typingSummary(conversation._id)) {
              <small class="typing">{{ typingSummary(conversation._id) }}</small>
            }
          </li>
        }
      </ul>
    }
  </aside>

  <section class="chat-panel" *ngIf="selectedConversation as activeConversation; else placeholder">
    <header>
      <div>
        <h2>{{ activeConversation.displayName }}</h2>
        <p>
          {{ activeConversation.participantsInfo?.length || 0 }} participants
        </p>
      </div>
      <div class="actions">
        <button class="link report-btn" (click)="openReportModal(activeConversation)">
          Report
        </button>
        <button class="link" (click)="loadMessages(activeConversation)">
          Refresh
        </button>
      </div>
    </header>

    <div class="messages" #messageList>
      @if (hasMoreMessages) {
        <button class="link load-more" (click)="loadOlderMessages()">
          Load previous messages
        </button>
      }

      @if (messagesLoading && !messages.length) {
        <div class="state">Loading messages...</div>
      } @else if (messagesError) {
        <div class="error-message">{{ messagesError }}</div>
      } @else if (!messages.length) {
        <div class="state">Start the conversation!</div>
      } @else {
        <div class="message"
             *ngFor="let message of messages; trackBy: trackByMessage"
             [class.me]="isOwnMessage(message)">
          <div class="bubble">
            <div class="meta">
              <span class="author">{{ message.sender?.username || 'Unknown' }}</span>
              <span class="time">{{ message.createdAt | date:'shortTime' }}</span>
            </div>
            <p>{{ message.content }}</p>
          </div>
        </div>
      }
    </div>

    <div class="composer">
      <textarea
        [(ngModel)]="messageContent"
        (ngModelChange)="onMessageInputChange()"
        placeholder="Write a message..."
      ></textarea>
      <button class="btn-primary" (click)="sendMessage()" [disabled]="!messageContent.trim()">
        Send
      </button>
    </div>
  </section>

  <ng-template #placeholder>
    <section class="chat-panel placeholder">
      <p>Select a conversation to start chatting.</p>
    </section>
  </ng-template>
</div>

<!-- Report Modal -->
<div class="modal-overlay" *ngIf="showReportModal && selectedConversation" (click)="closeReportModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <h3>Report {{ reportTarget === 'event' ? 'Event' : 'User' }}</h3>
      <button type="button" class="close-btn" (click)="closeReportModal()">×</button>
    </header>

    <div class="modal-body">
      <div *ngIf="reportTarget === 'event'">
        <div class="report-info">
          <h4>Reporting Event: {{ selectedConversation.displayName }}</h4>
          <p>You are about to report this event for violating community guidelines.</p>
        </div>
      </div>
      <div *ngIf="reportTarget === 'user'">
        <div class="report-info">
          <h4>Select User to Report</h4>
          <p>Choose which user you want to report from this conversation:</p>
          
          <!-- User selection dropdown with search -->
          <div class="user-selector">
            <div class="dropdown-container">
              <input
                type="text"
                class="user-search-input"
                [(ngModel)]="userSearchTerm"
                (input)="onUserSearchInput()"
                (focus)="showUserDropdown = true"
                placeholder="Search users..."
                autocomplete="off">
              
              @if (selectedUserId) {
                <div class="selected-user-display">
                  <span class="selected-user-name">{{ selectedUserName }}</span>
                  <button type="button" class="clear-selection" (click)="selectedUserId = null; userSearchTerm = ''">×</button>
                </div>
              }
              
              @if (showUserDropdown && filteredUsers.length > 0) {
                <div class="user-dropdown">
                  <div 
                    class="user-option"
                    *ngFor="let user of filteredUsers"
                    (click)="selectUserToReport(user.id)">
                    <span class="user-avatar">{{ user.username.charAt(0).toUpperCase() }}</span>
                    <span class="user-info">
                      <span class="username">{{ user.username }}</span>
                    </span>
                  </div>
                </div>
              }
              
              @if (showUserDropdown && filteredUsers.length === 0 && userSearchTerm.trim()) {
                <div class="user-dropdown">
                  <div class="no-users">No users found</div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Report target selection for event chats -->
      <div *ngIf="selectedConversation?.type === 'event_group'" class="report-target-selection">
        <h4>What do you want to report?</h4>
        <div class="target-options">
          <label class="target-option">
            <input
              type="radio"
              name="reportTarget"
              value="event"
              [(ngModel)]="reportTarget">
            <span>Report the Event</span>
          </label>
          <label class="target-option">
            <input
              type="radio"
              name="reportTarget"
              value="user"
              [(ngModel)]="reportTarget">
            <span>Report a User</span>
          </label>
        </div>
      </div>

      <form class="report-form">
        <label>
          Reason *
          <select [(ngModel)]="reportReason" name="reason" required>
            <option value="">Select a reason</option>
            <option value="spam">Spam</option>
            <option value="harassment">Harassment</option>
            <option value="inappropriate_content">Inappropriate Content</option>
            <option value="fake_event">Fake Event</option>
            <option value="scam">Scam</option>
            <option value="other">Other</option>
          </select>
        </label>

        <label>
          Description (optional)
          <textarea
            [(ngModel)]="reportDescription"
            name="description"
            rows="3"
            placeholder="Provide additional details about the issue...">
          </textarea>
        </label>
      </form>
    </div>

    <footer class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeReportModal()">
        Cancel
      </button>
      <button
        type="button"
        class="btn-primary"
        (click)="submitReport(selectedConversation)"
        [disabled]="!reportReason || (reportTarget === 'user' && !selectedUserId)">
        Submit Report
      </button>
    </footer>
  </div>
</div>
